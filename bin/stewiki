#!/usr/bin/env ruby
require File.dirname(__FILE__) + '/../lib/stewiki'
require 'sinatra'

set :root, File.dirname(__FILE__)  + '/../lib/stewiki/server'

get "/" do
  redirect to('/page/Home')
end

get "/page/:pagename" do
  @title = params[:pagename]
  @page_last_modified = Stewiki::Page[params[:pagename]].last_modified || "Never"
  @page_last_commit = Stewiki::Page[params[:pagename]].last_commit.to_s[0..7] || "N/A"
  @content = Stewiki.render(params[:pagename], :renderer => :html)
  haml :display
end

get "/edit/:pagename" do
  @title = "Editing: " + params[:pagename]
  ## REFACTOR: Passing in variables to templates
  page = Stewiki::Page[params[:pagename]]
  @page_last_modified = page.last_modified || "Never"
  @page_last_commit = page.last_commit.to_s[0..7] || "N/A"
  @content = page.content
  @commit_message = page.default_commit_message
  haml :edit
end

post "/edit/:pagename" do
  Stewiki.update(params[:pagename], params[:content], params[:commit_message])
  redirect to("/page/" + params[:pagename])
end
